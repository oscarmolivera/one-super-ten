<turbo-frame id="performance_frame_<%= @match.id %>">
  <%= form_with model: match, url: match_path(@match), method: :patch, data: { turbo_frame: "_self" } do |f| %>
    <div class="card shadow-lg border-0 rounded-3 mb-4">
      <div class="card-header bg-success-light text-muted rounded-top">
        <h4 class="mb-0 fw-bold">
          Editar Detalles del Partido |
          <small class="text-success">Partido ID: <%= @match.id %></small>
        </h4>
      </div>

      <div class="card-body p-4">

        <!-- Goles de ambos equipos -->
        <div class="row text-center mb-4">
          <div class="col-md-6">
            <% if match.plays_as == "home" %>
              <%= team_score_input_block(f, team: match.team_of_interest, fallback_name: ActsAsTenant.current_tenant.name, score_attr: :team_score, label_text: "Goles Anotados:", match: match) %>
            <% else %>
              <%= team_score_input_block(f, team: match.rival, score_attr: :rival_score, label_text: "Goles Anotados:", match: match) %>
            <% end %>
          </div>
          <div class="col-md-6">
            <% if match.plays_as == "home" %>
              <%= team_score_input_block(f, team: match.rival, score_attr: :rival_score, label_text: "Goles Anotados:", match: match) %>
            <% else %>
              <%= team_score_input_block(f, team: match.team_of_interest, fallback_name: ActsAsTenant.current_tenant.name, score_attr: :team_score, label_text: "Goles Anotados:", match: match) %>
            <% end %>
          </div>
        </div>

        <!-- Árbitro debajo, centrado y con ancho reducido -->
        <div class="row">
          <div class="col text-center">
            <label for="match_referee" class="form-label fw-semibold text-muted">Árbitro Principal</label>
            <%= f.text_field :referee, class: "form-control w-200 mx-auto text-center", placeholder: "Nombre del árbitro" %>
          </div>
        </div>

        <div class="row mt-5">
          <div class="col">
            <h5 class="fw-bold mb-3">Rendimiento de Jugadores Convocados</h5>
            <% rows = SeasonTeams::MatchPerformanceTableService.new(@match).rows %>
            <table class="table table-bordered table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>Jugador</th>
                  <th>Minutos</th>
                  <th>Goles</th>
                  <th>Asistencias</th>
                  <th>Amarillas</th>
                  <th>Rojas</th>
                  <th>Notas</th>
                </tr>
              </thead>
              <tbody>
                <% rows.each do |row| %>
                  <tr>
                    <td>
                      <%= row.performer.try(:full_name) || "#{row.performer.try(:first_name)} #{row.performer.try(:last_name)}" %>
                    </td>
                    <td>
                      <%= f.fields_for :match_performances, row.performance do |pf| %>
                        <%= pf.number_field :minute_of_event, min: 0, class: "form-control form-control-sm", style: "width: 70px;" %>
                        <%= pf.hidden_field :performer_type %>
                        <%= pf.hidden_field :performer_id %>
                      <% end %>
                    </td>
                    <td>
                      <%= f.fields_for :match_performances, row.performance do |pf| %>
                        <%= pf.number_field :goals_scored, min: 0, class: "form-control form-control-sm", style: "width: 60px;" %>
                      <% end %>
                    </td>
                    <td>
                      <%= f.fields_for :match_performances, row.performance do |pf| %>
                        <%= pf.number_field :assists, min: 0, class: "form-control form-control-sm", style: "width: 60px;" %>
                      <% end %>
                    </td>
                    <td>
                      <%= f.fields_for :match_performances, row.performance do |pf| %>
                        <%= pf.number_field :yellow_cards, min: 0, class: "form-control form-control-sm", style: "width: 60px;" %>
                      <% end %>
                    </td>
                    <td>
                      <%= f.fields_for :match_performances, row.performance do |pf| %>
                        <%= pf.number_field :red_cards, min: 0, class: "form-control form-control-sm", style: "width: 60px;" %>
                      <% end %>
                    </td>
                    <td>
                      <%= f.fields_for :match_performances, row.performance do |pf| %>
                        <%= pf.text_field :notes, class: "form-control form-control-sm", style: "width: 120px;" %>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
            <% if rows.empty? %>
              <div class="alert alert-warning text-center">No hay jugadores convocados para este partido.</div>
            <% end %>
          </div>
        </div>

      </div>

      <div class="card-footer bg-light border-0 p-3 d-flex justify-content-end gap-2">
        <%= f.hidden_field :status, value: :played %>
        <%= f.submit "Guardar Marcador", class: "btn btn-primary btn-lg px-4" %>
        <button type="button" class="btn btn-outline-secondary btn-lg px-4" data-action="click->frame-closer#close">
          Cancelar
        </button>
      </div>
    </div>
  <% end %>
</turbo-frame>