<%= turbo_frame_tag "call_up_frame_#{match.id}" do %>
  <%= form_with model: call_up,
                url: call_up.persisted? ? call_up_path(call_up) : match_call_ups_path(match),
                method: call_up.persisted? ? :patch : :post,
                html: {style: "background-color: #f3f5f9; padding: 15px;"},
                data: { turbo_frame: "_top" } do |f| %>

    <%= f.hidden_field :match_id %>
    <%= f.hidden_field :category_id, value: call_up.category_id %>

    <div class="mb-3">
      <%= f.label :name, "Nombre de la Convocatoria" %>
      <%= f.text_field :name, class: "form-control" %>
    </div>

    <div class="row mb-3">
      <div class="col-md-6">
        <%= label_tag :call_up_date_only, "DÃ­a de la Convocatoria", class: "form-label" %>
        <%= date_field_tag :call_up_date_only,
                          call_up.call_up_date&.to_date,
                          class: "form-control",
                          readonly: true, disabled: true%>
      </div>

      <div class="col-md-6">
        <%= label_tag :call_up_time_only, "Hora de la Convocatoria", class: "form-label" %>
        <%= time_field_tag :call_up_time_only,
              (call_up.call_up_date&.strftime("%H:%M") || (@match.scheduled_at - 1.hour).strftime("%H:%M")),
              class: "form-control",
              placeholder: (@match.scheduled_at - 1.hour).strftime("%H:%M") %>
      </div>
    </div>

    <% if @season_team_players.any? %>
      <div class="mb-3" data-controller="call-up-selector">
        <%= f.label :player_ids, "Jugadores Convocados" %>

        <div class="mb-2">
          <button type="button"
                  class="btn btn-sm btn-danger-light"
                  data-action="click->call-up-selector#selectAll">
            Seleccionar Todos
          </button>
        </div>
        <% selected_player_ids = call_up.call_up_players.pluck(:player_id).compact.map { |id| "player-#{id}" } %>
        <% selected_external_ids = call_up.call_up_players.pluck(:external_player_id).compact.map { |id| "external-#{id}" } %>
        <% selected_values = selected_player_ids + selected_external_ids %>
        <div data-call-up-selector-target="checkboxes">
          <% @season_team_players.each do |stp| %>
            <% value = stp.player_id ? "player-#{stp.player_id}" : "external-#{stp.external_player_id}" %>
            <% checked = selected_values.include?(value) %>
            <% name = stp.player&.full_name || stp.external_player&.full_name || "Sin Nombre" %>
            <% badge = if stp.external_player.present?
                        content_tag(:span, "EXTERNO*", class: "badge bg-warning text-dark ms-2")
                      else
                        category = st_player_category(stp)
                        content_tag(:span, category, class: "badge bg-info text-dark ms-2")
                      end %>

            <div class="form-check p-2 mb-2 rounded <%= player_origin_class(stp) %>">
              <%= check_box_tag "call_up[player_ids][]", value, checked, class: "form-check-input", id: "call_up_player_#{value}" %>
              <%= label_tag "call_up_player_#{value}", raw("#{name} #{badge}"), class: "form-check-label d-flex align-items-center" %>
            </div>
          <% end %>
        </div>
      </div>
    <% else %>
      <div class="alert alert-info">No hay jugadores disponibles.</div>
    <% end %>

    <div class="mt-3 d-flex gap-2">
      <%= f.submit "Guardar Convocatoria", class: "btn btn-primary" %>
      <button type="button"
              class="btn btn-outline-secondary"
              data-action="click->call-up-cleaner#cleanup click->frame-closer#close">
        Cerrar
      </button>
    </div>

  <% end %>
<% end %>

<style>
  .call-up-form {
    background-color: #;
    padding: 15px;
  }

  .call-up-form .form-check {
    margin-bottom: 0.5rem;
  }

  .call-up-form .form-check-label {
    margin-left: 0.5rem;
  }
</style>